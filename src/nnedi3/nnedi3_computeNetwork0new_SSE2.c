const long long sign_bits_f[2] __attribute__((aligned(16))) = { 0x7FFFFFFF7FFFFFFF, 0x7FFFFFFF7FFFFFFF };
const long long sign_bits_f_zero_l[2] __attribute__((aligned(16))) = { 0x7FFFFFFF00000000, 0x7FFFFFFF7FFFFFFF };

const float ones_f[4] __attribute__((aligned(16))) = { 1.0f, 1.0f, 1.0f, 1.0f };

void computeNetwork0new_SSE2(const float *datai, const float *weights, unsigned char *d) {
	__asm__ {
		mov rcx,datai
		mov rax,weights
		movdqa xmm0,[rcx]
		movdqa xmm1,xmm0
		movdqa xmm2,xmm0
		movdqa xmm3,xmm0
		pmaddwd xmm0,[rax]
		pmaddwd xmm1,[rax+16]
		pmaddwd xmm2,[rax+32]
		pmaddwd xmm3,[rax+48]
		movdqa xmm4,[rcx+16]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+64]
		pmaddwd xmm5,[rax+80]
		pmaddwd xmm6,[rax+96]
		pmaddwd xmm7,[rax+112]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,[rcx+32]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+128]
		pmaddwd xmm5,[rax+144]
		pmaddwd xmm6,[rax+160]
		pmaddwd xmm7,[rax+176]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,[rcx+48]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+192]
		pmaddwd xmm5,[rax+208]
		pmaddwd xmm6,[rax+224]
		pmaddwd xmm7,[rax+240]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,[rcx+64]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+256]
		pmaddwd xmm5,[rax+272]
		pmaddwd xmm6,[rax+288]
		pmaddwd xmm7,[rax+304]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,[rcx+80]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+320]
		pmaddwd xmm5,[rax+336]
		pmaddwd xmm6,[rax+352]
		pmaddwd xmm7,[rax+368]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,[rcx+96]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+384]
		pmaddwd xmm5,[rax+400]
		pmaddwd xmm6,[rax+416]
		pmaddwd xmm7,[rax+432]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,[rcx+112]
		movdqa xmm5,xmm4
		movdqa xmm6,xmm4
		movdqa xmm7,xmm4
		pmaddwd xmm4,[rax+448]
		pmaddwd xmm5,[rax+464]
		pmaddwd xmm6,[rax+480]
		pmaddwd xmm7,[rax+496]
		paddd xmm0,xmm4
		paddd xmm1,xmm5
		paddd xmm2,xmm6
		paddd xmm3,xmm7
		movdqa xmm4,xmm0
		movdqa xmm5,xmm2
		punpcklqdq xmm0,xmm1
		punpcklqdq xmm2,xmm3
		punpckhqdq xmm4,xmm1
		punpckhqdq xmm5,xmm3
		paddd xmm0,xmm4
		paddd xmm2,xmm5
		movdqa xmm6,xmm0
		shufps xmm0,xmm2,136
		shufps xmm6,xmm2,221
		paddd xmm0,xmm6
		cvtdq2ps xmm0,xmm0
		mulps xmm0,[rax+512]
		addps xmm0,[rax+528]
		movaps xmm1,xmm0
		andps xmm0,sign_bits_f
		addps xmm0,ones_f
		rcpps xmm0,xmm0
		mulps xmm0,xmm1
		pshufd xmm1,xmm0,0
		pshufd xmm2,xmm0,85
		pshufd xmm3,xmm0,170
		pshufd xmm4,xmm0,255
		mulps xmm1,[rax+544]
		mulps xmm2,[rax+560]
		mulps xmm3,[rax+576]
		mulps xmm4,[rax+592]
		pxor xmm0,xmm0
		addps xmm1,xmm2
		addps xmm3,xmm4
		addps xmm1,xmm3
		mov rcx,d
		addps xmm1,[rax+608]
		cmpps xmm1,xmm0,1
		packssdw xmm1,xmm0
		packsswb xmm1,xmm0
		movd rax,xmm1
		xor eax,0xFFFFFFFF
		and rax,0x01010101
		mov [rcx],rax
	}
}
